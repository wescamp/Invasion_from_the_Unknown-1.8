#textdomain wesnoth-Invasion_from_the_Unknown

[scenario]
    id=20_Under_the_Sands
    name= _ "Under the Sands"
    # Note about the map: in the future I'll need artwork to make this place look heavily corrupted by demonish
    # presences.
    {MAP 20_Under_the_Sands.map}
    {TURNS 66 65 64}
    next_scenario=20x_Interlude
    victory_when_enemies_defeated=no

    {EX_SCENARIO_MUSIC_PLAYLIST (
        {EX_MUSIC        "snowfall.ogg"}
        {EX_MUSIC_APPEND "nunc_dimittis.ogg"}
        {EX_MUSIC_APPEND "into_the_shadows.ogg"}
    )}

    {UNDERGROUND}
    [+time]
        red,green,blue=-30,-60,-60
    [/time]

    {DEATHS_COMMON}
    {GLAMOUR_INIT_STUB}
    {GLAMOUR_EVENTS}

    {STORYTXT_UNDER_THE_SANDS}
    {STORYMAP_UNDER_THE_SANDS}

    [side]
        type=Elvish Hero
        id=Galas
        name= _ "Galas"
        unrenamable=yes
        side=1
        canrecruit=yes
        controller=human
        team_name=good
        user_team_name= _ "team_name^Allies"
        shroud=yes
    [/side]

    {STARTING_VILLAGES 1 4}

    [side]
        type=Chaos Razerman
        id=Renan
        name= _ "Renan"
        recruit=Chaos Invader,Chaos Invoker,Imp,Demon,Chaos Headhunter,Shadow Minion,Abomination
        canrecruit=yes
        side=2
        {GOLD 50 100 150}
        team_name=chaos
        user_team_name= _ "team_name^Loyalists"
        {CHAOS_FLAG}
        [ai]
            leader_value=10
            recruitment_pattern=fighter,mixed fighter,scout,fighter,mixed fighter,scout
        [/ai]
    [/side]

    [side]
        type=Verlissh Matrix Core
        id=Matrix1
        name= _ "Alien Matrix"
        side=3
        recruit=Shaxthal Runner Drone,Shaxthal Assault Drone,Psy Crawler,Shadow Minion,Imp,Verlissh Spearbearer,Abomination
        canrecruit=yes
        {GOLD 50 100 150}
        controller=ai
        team_name=chaos
        user_team_name= _ "team_name^Monsters"
        {CHAOS_FLAG}
        [ai]
            leader_value=20
            recruitment_pattern=mixed fighter,scout,mixed fighter,mixed fighter,fighter
        [/ai]
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 25 51}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 24 42}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 26 31}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 2 24}

        {GENERIC_GUARDIAN_AUTOSIDE (Prong Bug) 21 3}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Crawler) 20 4}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Crawler) 23 4}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 8 16}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 18 19}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 24 28}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 16 29}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 23 30}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 28 28}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 31 31}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 24 33}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 15 33}
        # Hive units
        # Note that Matrix parts may have ZoC being L0 for exploration purposes
#define __FORCE_ZOC
    [+unit]
        ellipse="misc/ellipse"
        [modifications]
            [trait]
                id=arbitrary_trait_id
                [effect]
                    apply_to="zoc"
                    value="1"
                [/effect]
            [/trait]
        [/modifications]
    [/unit]
#enddef
        # Matrix conducts on "shortcut" hive channels, mainly placed to discourage the player
        # from taking the "shortcut", therefore forcing him/her to navigate thru the whole hive
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 25 41}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 26 41}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 26 42}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 26 43}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 28 41}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 28 42}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 27 43}
        {__FORCE_ZOC}
        # Conducts on the eastern side passage; mainly placed to discourage the player
        # from exploring that zone
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 38 48}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 39 49}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 39 50}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 38 50}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 39 51}
        {__FORCE_ZOC}
        # In village chamber
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 28 53}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 34 54}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 32 53}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 28 52}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 35 52}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 35 53}
        {__FORCE_ZOC}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 35 54}
        {__FORCE_ZOC}
    [/side]

    [side]
        type=Shaxthal Protector Drone
        side=4
        recruit=Shaxthal Runner Drone,Shaxthal Drone,Verlissh Spearbearer,Abomination,Chaos Hound
        canrecruit=yes
        {GOLD 50 100 150}
        controller=ai
        team_name=chaos
        user_team_name= _ "team_name^Monsters"
        {CHAOS_FLAG}
        [ai]
            leader_value=20
            recruitment_pattern=mixed fighter,mixed fighter,fighter
        [/ai]
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Crawler) 25 10}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Crawler) 20 11}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Crawler) 28 7}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 17 10}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Minion) 16 9}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Minion) 17 11}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 16 13}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 29 7}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 17 8}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 29 15}
    [/side]

    [side]
        no_leader=yes
        side=5
        team_name=chaos
        {HIDDEN_TEAM}
        {CHAOS_FLAG}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 4 44}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 14 44}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 6 47}
        {GENERIC_GUARDIAN_AUTOSIDE (Abomination) 5 41}
        {GENERIC_GUARDIAN_AUTOSIDE (Abomination) 10 42}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Soulless) 11 46}
        [+unit]
            variation=swimmer
            {FACING_REVERSE}
        [/unit]
        {GENERIC_GUARDIAN_AUTOSIDE (Walking Corpse) 4 45}
        [+unit]
            variation=swimmer
        [/unit]
        {GENERIC_GUARDIAN_AUTOSIDE (Giant Leech) 9 50}
        {GENERIC_GUARDIAN_AUTOSIDE (Leech) 21 36}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Leech) 14 16}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Eyestalk) 6 17}
        {GENERIC_GUARDIAN_AUTOSIDE (Eyestalk) 8 36}
        {GENERIC_GUARDIAN_AUTOSIDE (Fire Spirit) 11 25}
        {GENERIC_GUARDIAN_AUTOSIDE (Fire Spirit) 18 23}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Fire Spirit) 24 20}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Fire Wisp) 20 26}
        {GENERIC_GUARDIAN_AUTOSIDE (Fire Wisp) 26 24}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Fire Wisp) 14 26}
    [/side]

    # Intial control variables table
    [event]
        name=prestart
        {VARIABLE got_glamour_amulet            no}
        {VARIABLE glamour_amulet_waiting_elynia no}
        {VARIABLE destroyed_matrices            0 }
        {VARIABLE enemy_casualties              0 }
    [/event]

    # Variable clean-up event
    [event]
        name=victory
        {CLEAR_VARIABLE got_glamour_amulet}
        {CLEAR_VARIABLE glamour_amulet_waiting_elynia}
        {CLEAR_VARIABLE enemy_casualties}
        # $destroyed_matrices is required to calculate the enemy strength on later scenaria, so we don't
        # remove it yet
    [/event]

    {HIVE_SPAWN_POINT ("Shaxthal Drone") 3 22 18 yes 9}

    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 3 22 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 5 23 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 3 24 yes 4}
#ifdef HARD
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 8 21 yes 3}
#endif
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 1 18 yes 5}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 4 28 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 3 30 yes 3}
#ifndef EASY
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 3 33 yes 3}
#endif

    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 17 42 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 18 43 yes 5}
#ifdef HARD
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 21 47 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 32 45 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 40 44 yes 6}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 7 51 yes 4}
#endif
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 24 43 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 22 39 yes 5}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 27 40 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 29 35 yes 6}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 33 38 yes 5}
#ifndef EASY
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 36 40 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 29 44 yes 5}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 35 46 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 38 43 yes 5}

    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 5 50 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 2 55 yes 7}
#endif
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 30 41 yes 5}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 34 44 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 35 48 yes 3}

    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 40 57 yes 1}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 34 59 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 36 60 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 3 38 61 yes 1}

    {SETUP_SHAXTHAL_ROAMING_SOUND_EFFECTS}

    [event]
        name=prestart
        {CONTINUOUS_SOUND_SOURCE glyph_power_up_ssrc1 36 3 ("glyph-powerup.ogg")}
        {CONTINUOUS_SOUND_SOURCE lava_ssrc1 17 24 ("ambient/lava.ogg")}
        {CONTINUOUS_SOUND_SOURCE lava_ssrc2 9 28 ("ambient/lava.ogg")}
        {CONTINUOUS_SOUND_SOURCE lava_ssrc3 28 20 ("ambient/lava.ogg")}
        {CONTINUOUS_SOUND_SOURCE lava_ssrc4 32 12 ("ambient/lava.ogg")}

        # wmllint: recognize Igor
        # wmllint: recognize Erathan
        # wmllint: recognize Elynia
        # wmllint: recognize Mal Keshar
        # Recall heroes
        {RECALL Elynia}
        {RECALL (Mal Keshar)}
        {RECALL Igor}
        {RECALL Erathan}

        {GLAMOUR_UI_SETUP}

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Find an exit (possibly south from your starting location) and move Mal Keshar or Elynia there.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Erathan")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
        [/objectives]
    [/event]

    [event]
        name=start
        [message]
            speaker=Galas
            message= _ "These noxious caves smell worse than a skunk's burrow."
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "That's a minor annoyance. There is something worser still in this place, something that I cannot easily describe with words. The air, the rocks, everything is unnatural."
        [/message]
        [message]
            speaker=Elynia
            message= _ "We have come down to the realm of chaos and corruption. The demons seem to be capable of corrupting our world with their very presence, and this is proof of it. If we don't stop them soon, the entire continent will be covered in eternal darkness, and all living beings will succumb to the power of Chaos."
        [/message]
        [message]
            speaker=Galas
            message= _ "Ugh... I..."
        [/message]
        {MSG_INNER ( _ "Yes, Galas, I can do more than merely speak to you. I can touch your mind, or crush it like an insect if I wish. You will not last very long if you continue to stay in my domain.")}
        [object]
            silent=yes
            [filter]
                id=Galas
            [/filter]
            [effect]
                apply_to=hitpoints
                increase=-50%
            [/effect]
        [/object]
        [redraw][/redraw]
        [message]
            speaker=Galas
            message= _ "Argh, it...hurts..."
        [/message]
        [message]
            speaker=Elynia
            message= _ "Galas!?"
        [/message]
        [object]
            silent=yes
            [filter]
                id=Galas
            [/filter]
            [effect]
                apply_to=hitpoints
                increase=-99%
            [/effect]
        [/object]
        [redraw][/redraw]
        [message]
            speaker=Galas
            message= _ "Ahhh... Help...mee!!"
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "Something is trying to contaminate and possess his mind. Elynia, invoke the power of Light and dispel the shadows from his body, or we'll lose him!"
        [/message]
        {THUNDER (
            [store_unit]
                [filter]
                    id=Galas
                [/filter]
                kill=yes
                variable=galas_store
            [/store_unit]
            [item]
                x=$galas_store.x
                y=$galas_store.y
                image="scenery/galas-unconscious.png~RC(magenta>red)"
            [/item]
            [redraw][/redraw]
        )}
        [message]
            speaker=Elynia
            message= _ "Galas, please don't die, we need you!"
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "Don't despair, girl. He is still alive, just unconscious right now."
        [/message]
        [message]
            speaker=Elynia
            message= _ "What should I do now?"
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "Lead the other living people until Galas regains consciousness. He will need to rest, but make sure he is not left alone in the darkness, for that would allow the shadows to contaminate him again."
        [/message]
        [message]
            speaker=Elynia
            message= _ "Very well."
        [/message]
        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            kill=yes
            variable=elynia_store
        [/store_unit]
        [removeitem]
            x=$galas_store.x
            y=$galas_store.y
        [/removeitem]
        [move_unit_fake]
            type=$elynia_store.type
            side=1
            x=$elynia_store.x|,$galas_store.x
            y=$elynia_store.y|,$galas_store.y
        [/move_unit_fake]
        {CLEAR_VARIABLE elynia_store.overlays}
        {VARIABLE elynia_store.x $galas_store.x}
        {VARIABLE elynia_store.y $galas_store.y}
        {VARIABLE elynia_store.canrecruit yes}
        {VARIABLE elynia_store.facing se}
        [unstore_unit]
            find_vacant=yes
            variable=elynia_store
        [/unstore_unit]
        {CLEAR_VARIABLE elynia_store}
        [redraw][/redraw]
    [/event]

    [event]
        name=turn 3
        [message]
            speaker=Elynia
            message= _ "I'm getting nervous. We should leave this place soon - we are too vulnerable in the darkness and the corruption of these haunted caves."
        [/message]
    [/event]

    [event]
        name=turn 9
        [message]
            speaker=Erathan
            message= _ "Were these tunnels our only option, Elynia? I'm beginning to think I would have preferred fighting on the surface than here."
        [/message]
        [message]
            speaker=Elynia
            message= _ "We could have done that, if we wanted to expose our location to the friends of that gigantic imp."
        [/message]
        [message]
            speaker=Erathan
            message= _ "Perhaps you have a point..."
        [/message]
    [/event]

    [event]
        name=turn 24
        [message]
            speaker=Mal Keshar
            message= _ "This is taking too long, and I'm getting impatient. Make haste, fools!"
        [/message]
        [message]
            speaker=Elynia
            message= _ "..."
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "Except you, lass, of course."
        [/message]
        [message]
            speaker=Erathan
            message= _ "..."
        [/message]
    [/event]

    [event]
        name=time over
        [message]
            speaker=Elynia
            message= _ "No!! We tarried here for too long, and now the drones have found and surrounded us! We are trapped between them and the cave walls. This is the end..."
        [/message]
    [/event]

    [event]
        {SIGHTED_SUF_BY_PLAYER (type=Verlissh Matrix Core)}
        [message]
            speaker=Mal Keshar
            message= _ "What in name of goodness is that thing?"
        [/message]
        [message]
            speaker=Erathan
            message= _ "Look out! It seems to be a matrix filled with the larvae of those abominations. Perhaps if we can destroy it they will abandon the pursuit."
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "That sounds like a decent plan. Let's smash it then."
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            canrecruit=yes
            side=3
        [/filter]
        [terrain]
            x,y=18,53-54
            terrain=Uu^Uf
        [/terrain]
        [terrain]
            x,y=21-22,59
            terrain=Wo
        [/terrain]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"Touchplate triggered. Two walls move."
        [/message]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            type=Verlissh Matrix Core
        [/filter]
        {VARIABLE_INC destroyed_matrices}
        #         [if]
        #             {VARIABLE_NUM_GREATER_OR_EQUAL_THAN destroyed_matrices {DIFF 2 3 4} }
        #             [then]
        #                 # Disable respawns
        #                 {VARIABLE global_respawning_flag 0}
        #             [/then]
        #         [/if]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            [not]
                side=1
            [/not]
        [/filter]
        {VARIABLE_INC enemy_casualties}
        [if]
            {VARIABLE_NUM_EQUALS enemy_casualties 10}
            [then]
                [message]
                    speaker=Erathan
                    message= _ "Please remember we have a mission to complete; we did not come down here to kill every foe we spot. We must keep moving."
                [/message]
                [message]
                    speaker=Mal Keshar
                    message= _ "Right, but it appears it is going to be impossible to remain unnoticed in these caves. We will be struck down by its inhabitants if we rush through carelessly."
                [/message]
                [message]
                    speaker=Elynia
                    message= _ "I fear that Mal Keshar is right. We have to get out of here, and I doubt we'll be able to without fighting with the natives."
                [/message]
                [message]
                    speaker=Erathan
                    message= _ "So, the plan has failed."
                [/message]
                [message]
                    speaker=Elynia
                    message= _ "I still hope all this noise will not alert the Emperor."
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=victory
        {VARIABLE galas_store.x 6}
        {VARIABLE galas_store.y 68}
        [item]
            x=$galas_store.x
            y=$galas_store.y
            image="scenery/galas-unconscious.png~RC(magenta>red)"
        [/item]

        # Move heroes to their dialogue locations and
        # set their facings so that all of them are looking at Galas
        # from different angles

        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_store
            kill=yes
        [/store_unit]
        {VARIABLE elynia_store.overlays "misc/hero-icon.png"}
        {VARIABLE elynia_store.canrecruit no}
        {VARIABLE elynia_store.x 5}
        {VARIABLE elynia_store.y 68}
        {VARIABLE elynia_store.facing se}
        [unstore_unit]
            variable=elynia_store
            find_vacant=yes
        [/unstore_unit]
        {CLEAR_VARIABLE elynia_store}

#define __TELEPORT_AND_SET_FACING _ID _X _Y _FACING
    [store_unit]
        [filter]
            id={_ID}
        [/filter]
        kill=yes
        variable=temp_TaSF_store
    [/store_unit]
    {VARIABLE temp_TaSF_store.x ({_X})}
    {VARIABLE temp_TaSF_store.y ({_Y})}
    {VARIABLE temp_TaSF_store.facing ({_FACING})}
    [unstore_unit]
        find_vacant=yes
        variable=temp_TaSF_store
    [/unstore_unit]
    {CLEAR_VARIABLE temp_TaSF_store}
#enddef
        {__TELEPORT_AND_SET_FACING (Mal Keshar) 7 68 sw}
        {__TELEPORT_AND_SET_FACING (Erathan) 6 67 s}
        [if]
            [have_unit]
                side=1
                id=Igor
            [/have_unit]
            [then]
                {__TELEPORT_AND_SET_FACING (Igor) 5 69 ne}
            [/then]
        [/if]
#undef __TELEPORT_AND_SET_FACING
        [remove_shroud]
            side=1
            {RECT 3 65 11 70}
        [/remove_shroud]
        [redraw][/redraw]
        [scroll_to_unit]
            id=Mal Keshar
        [/scroll_to_unit]
        [redraw][/redraw]
        [delay]
            time=1300
        [/delay]
        [message]
            speaker=Mal Keshar
            message= _ "When is the lad going to wake up? This is starting to worry me."
        [/message]
        [message]
            speaker=Elynia
            message= _ "Galas..."
        [/message]
        [redraw][/redraw]
        [delay]
            time=1500
        [/delay]
        [message]
            speaker=narrator
            message= _ "A whisper..."
        [/message]
        [redraw][/redraw]
        [delay]
            time=500
        [/delay]
        [message]
            speaker=narrator
            message= _ "And a light..."
        [/message]
        [redraw][/redraw]
        [delay]
            time=500
        [/delay]
        [removeitem]
            x=$galas_store.x
            y=$galas_store.y
        [/removeitem]
        [unstore_unit]
            variable=galas_store
            find_vacant=yes
        [/unstore_unit]
        {CLEAR_VARIABLE galas_store}
        [redraw][/redraw]
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Igor
            message= _ "Master Galas! I'm really happy seeing ya alright!"
        [/message]
        [message]
            speaker=Elynia
            message= _ "Galas, oh, I almost thought we had lost you!"
        [/message]
        [message]
            speaker=Galas
            message= _ "Elynia...what happened? Where are we?"
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "'What happened?' Why the hell are you asking us?! What happened to *you*, is the question!?"
        [/message]
        [message]
            speaker=Elynia
            message= _ "Galas, you almost made us think you had died! But what happened to you shortly after entering the cave, is what we want to know."
        [/message]
        [message]
            speaker=Galas
            message= _ "No, you would not believe me if I told you. You would think I was insane, or that I had been possessed by the enemy!"
        [/message]
        [message]
            speaker=Erathan
            message= _ "Galas, really, there is nothing to hide. We witnessed the shadows trying to absorb your unconscious body."
        [/message]
        [message]
            speaker=Elynia
            message= _ "Galas, please tell us. We are your friends, and will support you in any case."
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "Aye. Tell us."
        [/message]
        [message]
            speaker=Galas
            message= _ "It seems that I'm too weak-minded. The Chaos lord attempted to invade and destroy my mind, ranting and boasting about his power in the darkness... He tried to convince me to slay you... He tempted me... He almost..."
        [/message]
        [message]
            speaker=Elynia
            message= _ "Galas, don't feel guilty. If he had managed to access my mind, he could have even possessed me. But it seems his powers are severely diminished by my light, as that is what I used to save you."
        [/message]
        [message]
            speaker=Galas
            message= _ "The light? That makes sense, he said he is stronger in the darkness of the caves - even stronger than he is here, his own domain."
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "Increased powers in the darkness of his territory... That fat imp said something about a so-called 'Shadow Master'. All those goons mention their 'Master' in every sentence they speak. It seems that this guy must have strong psychic powers, as strong as his control of the shadows; all of his minions are probably just enslaved minds under his direction. But, Elynia...you mentioned that your fiancé fell during an earthquake, am I right?"
        [/message]
        [message]
            speaker=Elynia
            message= _ "Yes, you are. But what has that to do with this problem?"
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "I am starting to wonder... Could there be a correlation? Could it be that this 'Shadow Master' is actually your fiancé, Argan?"
        [/message]
        [message]
            speaker=Elynia
            message= _ "What?! No, impossible! Where did you get such an idea, fool!"
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "Think about the connections... Both of them have a grand control over Darkness. One of them, Argan, disappeared; the other one, this Shadow Master, then appeared out of nowhere. Couldn't it be that Argan became possessed by an evil force in the very depths of the earth, an evil force of darkness, and it turned him against the world? I now understand why you were not affected by the corruption of such places, Elynia, and it is yourself; your own internal light protects you and those around you. But Argan himself was a being of darkness, and very prone to corruption."
        [/message]
        [message]
            speaker=Elynia
            message= _ "No, it can't be! The exact reason we became engaged was because he had saved me with the powers of darkness for good. He is not evil. He cannot be turned to evil. Mal Keshar, you are a lich, I cannot trust your word, nor can I accept your reasoning."
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "Ah. Sorry then, girl. I hope that I am proven wrong, in any case."
        [/message]
        [message]
            speaker=Elynia
            message= _ "And Galas, I'll make sure this does happen a second time. I'll protect you from the darkness constantly from now on."
        [/message]
        [message]
            speaker=Galas
            message= _ "Thank you, Elynia."
        [/message]
        [message]
            speaker=Erathan
            message= _ "Now, we have some work to finish."
        [/message]
        [message]
            speaker=Galas
            message= _ "Yes, indeed..."
        [/message]
    [/event]

    # Victory triggerer
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=1-20
            y=66-70
            [and]
                id=Mal Keshar
                [or]
                    id=Elynia
                [/or]
            [/and]
        [/filter]
        # Don't allow player to escape the hive so easily if one of the heroes are in the alien hive
        [if]
            [have_unit]
                id=Mal Keshar
                {RECT 20 38 40 61}
            [/have_unit]
            {OR (
                [have_unit]
                    id=Mal Keshar
                    {RECT 24 35 40 45}
                [/have_unit]
            )}
            {OR (
                [have_unit]
                    id=Elynia
                    {RECT 20 38 40 61}
                [/have_unit]
            )}
            {OR (
                [have_unit]
                    id=Elynia
                    {RECT 24 35 40 45}
                [/have_unit]
            )}
            [then]
                [if]
                    {VARIABLE_LEXICAL_EQUALS unit.id "Mal Keshar"}
                    [then]
                        [message]
                            speaker=unit
                            message= _ "Wait! We can't leave Elynia behind in the alien hive!"
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=unit
                            message= _ "Wait! We can't leave Mal Keshar behind in the alien hive!"
                        [/message]
                    [/else]
                [/if]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "Are we ready to exit these caverns?"
                    [option]
                        message={STR_YES} # wmllint: ignore
                        [command]
                            {ENDLEVEL_VICTORY yes}
                        [/command]
                    [/option]
                    [option]
                        message={STR_NO} # wmllint: ignore
                    [/option]
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [and]
                {RECT 20 38 40 61}
                [or]
                    {RECT 24 35 40 45}
                [/or]
            [/and]
            [and]
                id=Mal Keshar
                [or]
                    id=Elynia
                [/or]
            [/and]
        [/filter]
        [allow_undo][/allow_undo]
        [redraw][/redraw]
        [message]
            speaker=Erathan
            message= _ "Where are you going? We didn't come here to fight against all of these creeps. If you enter their nest we'll have to wait for you to come back out before leaving this cursed place!"
        [/message]
    [/event]

    # Touchplate 33 8
    {ITEM_TOUCHPLATE 33 8}
    [event]
        name=moveto
        [filter]
            side=1
            x,y=33,8
        [/filter]

        [removeitem]
            x,y=33,8
        [/removeitem]

        [terrain]
            x,y=28,6
            terrain=Ryd # wmllint: ignore
        [/terrain]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"Touchplate triggered. A wall moves."
        [/message]
    [/event]

    # Amulet of Metamorphosis: it allows Elynia to completely mimic other creatures' appearance, stats
    # and abilities, enhancing her natural faerie glamour.

    # Weird method for granting a hex double haloes, but it worked in 1.0.2 IIRC
    {ITEM_CRYSTAL_GLYPH 36 3}
    [item]
        x,y=36,3
        halo=scenery/circle-magic-glow.png
    [/item]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=36,3
            side=1
            [not]
                id=Elynia
            [/not]
        [/filter]
        # Control variables, declared in prestart:
        # got_glamour_amulet (BOOLEAN)
        # glamour_amulet_waiting_elynia (BOOLEAN)
        [if]
            {VARIABLE_BOOLEAN_EQUALS got_glamour_amulet no}
            [then]
                [if]
                    {VARIABLE_BOOLEAN_EQUALS glamour_amulet_waiting_elynia no}
                    [then]
                        {VARIABLE glamour_amulet_waiting_elynia yes}
                        [objectives]
                            side=1
                            {OBJECTIVE_TO_WIN ( _ "Find an exit (possibly south from your starting location) and move Mal Keshar or Elynia there.")}
                            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
                            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
                            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
                            {OBJECTIVE_TO_LOSE ( _ "Death of Erathan")}
                            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
                            {OBJECTIVE_NOTES ( _ "Bring Elynia to ($x1|,$y1|) in order to activate the mysterious glyph.")}
                        [/objectives]
                        # Dead men tell no tales
                        [if]
                            {VARIABLE_LEXICAL_EQUALS unit.race undead}
                            [then]
                                [message]
                                    speaker=unit
                                    message= _ "Master, master! I have found a giant crystal object floating in here!"
                                [/message]
                                [message]
                                    speaker=Mal Keshar
                                    message= _ "Sounds similar to those we found while looking for Elynia in the depths of the Unknown. Can you describe it?"
                                [/message]
                                [message]
                                    speaker=unit
                                    message= _ "Well, it is giant, it glows brightly with a blueish color, and it illuminates the chamber completely, as if it was a powerful torch. I can barely stand to look at it for very long."
                                [/message]
                            [/then]
                            [else]
                                # Bats don't speak English
                                [if]
                                    {VARIABLE_LEXICAL_EQUALS unit.race bats}
                                    [then]
                                        {DUMMY ( _ "NOTE FOR TRANSLATORS: the 'translated' bat messages should sound clumsy in any language, as if it was a Troll speaking for the bat.")}
                                        [message]
                                            speaker=unit
                                            message= _ "Neep, neep! (Translated from bat's language: 'master, giant crystal here, flies around, must see it'.)"
                                        [/message]
                                        [message]
                                            speaker=Mal Keshar
                                            message= _ "The bat has found something, and it seems to be one of those crystal glyphs that we found while looking for Elynia in the depths of the Unknown."
                                        [/message]
                                        [message]
                                            speaker=Erathan
                                            message= _ "You can speak with the bat!?"
                                        [/message]
                                        [message]
                                            speaker=unit
                                            message= _ "Neep, neep, neeep! (Translated from bat's language: 'great, glows blue, bright as sunlight, blinds me'.)"
                                        [/message]
                                    [/then]
                                    [else]
                                        [message]
                                            speaker=unit
                                            message= _ "Whew, talking about strange things down here... Hey all, I've found a large, hovering crystalline object in this section of the cave!"
                                        [/message]
                                        [message]
                                            speaker=Mal Keshar
                                            message= _ "Sounds similar to those we found while looking for Elynia in the depths of the Unknown. Can you describe it?"
                                        [/message]
                                        [message]
                                            speaker=unit
                                            message= _ "Well, it is giant, it glows brightly with a blueish color, and it illuminates the chamber completely, as if it was a powerful torch. I can barely stand to look at it for very long."
                                        [/message]
                                    [/else]
                                [/if]
                            [/else]
                        [/if]
                        [message]
                            speaker=Mal Keshar
                            message= _ "It is definitely one of those magic crystals."
                        [/message]
                        [message]
                            speaker=Elynia
                            message= _ "I sense...something calling me from there. I must see this glyph."
                        [/message]
                        [message]
                            speaker=Mal Keshar
                            message= _ "Oh really? Go ahead if you desire. And you, my loyal rats, follow Elynia and make sure the boy is being kept illuminated!"
                        [/message]
                        [message]
                            speaker=narrator
                            image="units/undead-skeletal/skeleton.png~RC(magenta>red)"
                            caption={STR_SKELETON} # wmllint: ignore
                            message= _ "Yes, master!"
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=narrator
                            image=wesnoth-icon.png
                            message= _ "Remember that you must bring Elynia to the amulet's location in order to use it."
                        [/message]
                    [/else]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Elynia
            side=1
            x,y=36,3
        [/filter]
        [if]
            {VARIABLE_BOOLEAN_EQUALS got_glamour_amulet no}
            [then]
                {VARIABLE got_glamour_amulet yes}
                [message]
                    speaker=Elynia
                    message= _ "Aahh... I can feel energy flowing through my veins."
                [/message]
                [if]
                    {VARIABLE_BOOLEAN_EQUALS glamour_amulet_waiting_elynia no}
                    [then]
                        # Dialogue from the folks if they didn't find the amulet before
                        [message]
                            speaker=Mal Keshar
                            message= _ "What is that?"
                        [/message]
                        [message]
                            speaker=Elynia
                            message= _ "This chamber has a large crystal glyph floating at its center, illuminating everything with a blueish glow. And the energy that flows from it and beckons me is...somehow familiar."
                        [/message]
                        [message]
                            speaker=Mal Keshar
                            message= _ "It sounds like one of those crystals we found in the depths of the Unknown. Be careful, at any rate. We don't know what it's made for."
                        [/message]
                    [/then]
                    [else]
                        # Dialogue from Elynia, Erathan and Mal Keshar if they had found the amulet
                        # before
                        {VARIABLE glamour_amulet_waiting_elynia no}
                        [objectives]
                            side=1
                            {OBJECTIVE_TO_WIN ( _ "Find an exit (possibly south from your starting location) and move Mal Keshar or Elynia there.")}
                            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
                            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
                            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
                            {OBJECTIVE_TO_LOSE ( _ "Death of Erathan")}
                            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
                        [/objectives]
                        [message]
                            speaker=Mal Keshar
                            message= _ "Just be careful, alright?"
                        [/message]
                    [/else]
                [/if]
                [message]
                    speaker=Elynia
                    message= _ "On a nearby pedestal there is a scroll. I'll open and read it. It will possibly explain something about this chamber."
                [/message]
                [message]
                    speaker=Mal Keshar
                    message= _ "Careful, lass, it could be a trap."
                [/message]
                [message]
                    speaker=Elynia
                    message= _ "No, I'm sure it is not."
                [/message]
                [message]
                    speaker=Elynia
                    message= _ "(reading the scroll) 'Faeries are known for their <i>glamour</i>, the ability to cast illusions to confuse their enemies, or even their victims. However, its power is limited to a simple visual illusion - other senses are not affected by it. Touch the glyph and use the spell stored within to enhance your power and acquire the ability to perform a complete metamorphosis rather than a mere illusion'."
                [/message]
                [message]
                    speaker=Elynia
                    message= _ "'Note: Only faeries can receive and use the spell from the glyph.'"
                [/message]
                [message]
                    speaker=Elynia
                    message= _ "Interesting."
                [/message]
                [message]
                    speaker=Erathan
                    message= _ "'Victims', hah. I was tricked by a faerie once, when I was nothing but a whelp of a lad. She tricked me to satisfy her instincts then abandoned me, only to find me again some time later causing me endless trouble."
                [/message]
                [message]
                    speaker=Mal Keshar
                    message= _ "Things like that happen. Elynia, what are you going to do?"
                [/message]
                [message]
                    speaker=Elynia
                    message= _ "I think we could use it. Who knows when it will come in handy."
                [/message]
                [message]
                    speaker=Mal Keshar
                    message= _ "I am not so familiar with the faerie world to have a proper opinion on this, but I'll say that it sounds perilous. How can you be sure that you will get your original body back after metamorphosing? It also seems like you would gain new weaknesses in the morphed state."
                [/message]
                [message]
                    speaker=Elynia
                    message= _ "Indeed it does, and I'm actually unsure about the other part. But I'll take the risk."
                [/message]
                [message]
                    speaker=Mal Keshar
                    message= _ "Hmph. Fine, then. I hope you don't endanger Galas by losing your ability of illumination in the process."
                [/message]
                [message]
                    speaker=Elynia
                    message= _ "I'll be alright, calm down. You are too nervous."
                [/message]
                [message]
                    speaker=Mal Keshar
                    message= _ "I am *not* nervous! Argh."
                [/message]
                [message]
                    speaker=Erathan
                    message= _ "Faeries."
                [/message]
                [scroll_to]
                    x=$x1
                    y=$y1
                [/scroll_to]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    message= _ "Elynia ascends and approaches the glyph, touching it with a hand. Immediately the glyph disintegrates and becomes a fine golden dust, covering her for a few moments..."
                [/message]
                # Now it's turn for the code that grants her the real ability
                [redraw][/redraw]
                [delay]
                    time=1300
                [/delay]
                [message]
                    speaker=Mal Keshar
                    message= _ "Well, now I am really starting to get nervous."
                [/message]
                [scroll_to]
                    x=$x1
                    y=$y1
                [/scroll_to]
                [animate_unit]
                    [filter]
                        x=$x1
                        y=$y1
                    [/filter]
                    flag=shine_golden
                    with_bars=no
                [/animate_unit]
                [removeitem]
                    x=$x1
                    y=$y1
                [/removeitem]
                {REMOVE_SOUND_SOURCE (glyph_power_up_ssrc1)}
                [terrain]
                    x=$x1
                    y=$y1
                    terrain=Uu
                [/terrain]
                [item]
                    x=$x1
                    y=$y1
                    halo=scenery/circle-magic.png
                [/item]
                [redraw][/redraw]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    message= _ "...until that too suddenly vanishes away. Yet, there is no noticeable difference to Elynia's appearance."
                [/message]
                {VARIABLE glamour_1st_time yes}
                # A fake ability is added to Elynia. Strictly a GUI decoration
                [object]
                    id=enhanced_glamour
                    [filter]
                        id=Elynia
                    [/filter]
                    silent=yes
                    duration=forever
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_GLAMOUR}
                        [/abilities]
                    [/effect]
                [/object]
                [store_unit]
                    [filter]
                        id=Elynia
                    [/filter]
                    variable=elynia_store
                [/store_unit]
                # It seems Wesnoth won't set the unit's resting status to 'no' unless this event
                # commands are completed (i.e. we reach the event's end) or we set it manually.
                {VARIABLE elynia_store.resting no}
                {GLAMOUR_DO_INITIALIZATION elynia_store}
                {GLAMOUR_REGISTER_VARIATION elynia_store shaxthal}
                {GLAMOUR_REGISTER_VARIATION elynia_store tiger}
                {GLAMOUR_REGISTER_VARIATION elynia_store imp}
                {GLAMOUR_REGISTER_VARIATION elynia_store rabbit}
                {GLAMOUR_REGISTER_VARIATION elynia_store falcon}
                [unstore_unit]
                    variable=elynia_store
                    find_vacant=no
                [/unstore_unit]
                {CLEAR_VARIABLE elynia_store}
                [redraw][/redraw]
                [message]
                    speaker=Elynia
                    message= _ "Do I look any different?"
                [/message]
                [message]
                    speaker=Mal Keshar
                    message= _ "Besides the golden flecks on your skin, not a bit."
                [/message]
                [message]
                    speaker=Elynia
                    message= _ "I guess I should try the spell first."
                [/message]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    message= _ "Elynia can transform into other lifeforms with the enhanced spell of Glamour! Be aware, though, that you must let her rest for a turn before being able to change her state. Read the ability's description for more information."
                [/message]
            [/then]
        [/if]
    [/event]
[/scenario]
#undef __FORCE_ZOC
