#textdomain wesnoth-Invasion_from_the_Unknown
[scenario]
    id=22B_Face_of_the_Enemy
    name= _ "Face of the Enemy"
    {MAP 22B_Face_of_the_Enemy.map}
    {TURNS 46 45 44}
    next_scenario=22C_Dark_Hive
    victory_when_enemies_defeated=no
    {NO_RECALLS}

    {EX_SCENARIO_MUSIC_PLAYLIST (
        {EX_MUSIC        "heroes_rite.ogg"  }
        {EX_MUSIC_APPEND "the_deep_path.ogg"}
        {EX_MUSIC_APPEND "nunc_dimittis.ogg"}
        {EX_MUSIC_APPEND "suspense.ogg"      }
    )}

    {INDOORS_HIVE}

    {DEATHS_END}
    {GLAMOUR_INIT_STUB}
    {GLAMOUR_EVENTS}

    {STORYTXT_GAUNTLET}
    {STORYMAP_GAUNTLET}

    [side]
        type=Elvish Hero
        id=Galas
        name= _ "Galas"
        unrenamable=yes
        side=1
        canrecruit=yes
        controller=human
        team_name=good
        user_team_name= _ "team_name^Galas"
        shroud=yes
        fog=yes
        income=-2
        gold=0
        village_gold=0
    [/side]

    # Boss supporters
    [side]
        side=2
        controller=ai
        no_leader=yes
        team_name=foes
        user_team_name= _ "team_name^Loyalists"
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {GENERIC_GUARDIAN_AUTOSIDE (Doom Guard) 25 25}
        {GENERIC_GUARDIAN_AUTOSIDE (Gutwrencher Imp) 12 29}
#ifndef EASY
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Lore) 23 33}
        {MAKE_FACING_REVERSE}
#endif
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Lore) 19 35}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Lore) 26 30}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Iron Golem) 16 27}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Iron Golem) 20 30}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Heavy Assault Trooper) 20 26}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Heavy Assault Trooper) 23 28}
        {MAKE_FACING_REVERSE}
    [/side]

    # Boss
    [side]
        side=3
        no_leader=yes
        team_name=foes
        user_team_name= _ "team_name^Loyalists"
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        [ai]
            # built-in default is 1.0, doesn't do it very well, so here I set 10.0
            # FIXME: looks like it prevents Elyssa from attacking
            # protect_leader=10.0
            # Dumb kamikaze-style AI which just wants to kill, no matter how
            # it should be. Focus on the leader anyway.
            leader_value=6
            caution=0.0
            aggression=1.0
            # Don't even think on recruiting; might save a few milliseconds
            # of gameplay, not sure.
            recruitment_pattern=""
            village_value=0.0
        [/ai]
    [/side]

    # Hive
    [side]
        side=4
        no_leader=yes
        team_name=foes
        user_team_name= _ "team_name^Hive dwellers"
        ai_algorithm=formula_ai
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        [ai]
            grouping=no
            [team_formula]
                rulebase="attacks"
            [/team_formula]
        [/ai]
    [/side]

    # Doors and matrices (fake player)
    [side]
        side=5
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {IS_NPC}
        {CHAOS_FLAG}
    [/side]

    # Side which controls wandering creatures
    [side]
        side=6
        controller=ai
        no_leader=yes
        {IS_HOSTILE_NPC}
        {CHAOS_FLAG}
        team_name=foes
        {HIDDEN_TEAM}

        {GENERIC_GUARDIAN_AUTOSIDE (Imp) 34 19}
        {MAKE_FACING_REVERSE}
#ifndef EASY
        {GENERIC_GUARDIAN_AUTOSIDE (Imp) 31 18}
#endif
    [/side]

    [side]
        side=7
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {HAS_KAMIKAZE_BEHAVIOR}

        {CHAOS_FLAG}

        # Final chamber matrix parts
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 33 30}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 29 27}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 29 33}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 27 34}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 18 36}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 20 36}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 12 35}

        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 14 36}

        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 10 32}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 15 32}

        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 9 31}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 14 26}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 11 28}

        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 23 25}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 25 26}

        # Watery area
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 39 13}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 38 15}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 35 14}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 38 16}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 36 16}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 44 10}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 39 12}

        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 45 15}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 50 15}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 41 9 }

        # Water chamber close to start
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 14 8 }
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 17 10}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 8  6 }
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 9  14}

        # Middle corridor close to start
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 21 16}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 20 14}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 22 15}
    [/side]

    {SETUP_SHAXTHAL_ROAMING_SOUND_EFFECTS}

    [event]
        name=prestart

        {PLACE_IMAGE ("items/bones.png~FL(horiz)") 27 29}
        {PLACE_IMAGE ("items/bones.png") 24 12}
        {PLACE_IMAGE ("items/bones.png~FL(horiz)") 42 10}
        {PLACE_IMAGE ("items/bones.png") 10 29}
        {PLACE_IMAGE ("items/bones.png") 13 32}
        {PLACE_IMAGE ("items/bones.png~FL(horiz)") 11 12}

        {PLACE_IMAGE ("items/altar-bloody.png") 17 29}

        {PLACE_IMAGE ("scenery/trash.png") 34 15}

        {VARIABLE trance_timeout 0 }

        [set_variables]
            name=door_locations

            [literal]
                x,y=32,20
            [/literal]
            [literal]
                x,y=33,21
            [/literal]

            [literal]
                x,y=15,14
            [/literal]

            [literal]
                x,y=10,10
            [/literal]
            [literal]
                x,y=11,10
            [/literal]
        [/set_variables]

        {FOREACH door_locations j}
            [unit]
                [modifications]
                    {TRAIT_MECHANICAL}
                [/modifications]
                type=Door
                side=5
                x,y="$door_locations[$j].x","$door_locations[$j].y"
            [/unit]
        {NEXT j}

        {CLEAR_VARIABLE door_locations}

        [recall]
            id=Elynia
        [/recall]
        [recall]
            id=Mal Keshar
        [/recall]
        [recall]
            id=Erathan
        [/recall]
        [recall]
            id=Lédinor
        [/recall]
        [recall]
            id=Igor
        [/recall]

        {GAUNTLET_RECALL_METALIST}

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Explore and find your way to the main keep with Galas, Elynia, or Mal Keshar.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES {ENEMY_RESPAWNING_WARNING} }
        [/objectives]
    [/event]

    # Setup NPC spawn points
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 8  18 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 32 27 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 7  25 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 20 37 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 45 28 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 38 25 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 40 19 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 33 13 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 20 6  yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 35 6  yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 5  4  yes 2}

    # Setup NPC behavior
    {NPC_BIRD_BEHAVIOR 6 1 51 1 38}

    # Setup enemy spawn points
#ifdef HARD
    # Boss arena
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 18 33 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 26 28 yes 4}

    # Hive's external area
    {HIVE_SPAWN_POINT ("Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 28 11 yes 3}

    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 24 23 yes 4}
#endif

#ifndef EASY
    # Hive's external area
    {HIVE_SPAWN_POINT ("Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 29 13 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 27 10 yes 2}

    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 24 30 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 26 29 yes 4}
#endif

    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 29 11 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 26 10 yes 3}

    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 27 12 yes 4}

    {HIVE_SPAWN_POINT ("Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 12 31 yes 7}

    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 30 24 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 29 25 no 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 25 22 no 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 28 26 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 22 23 yes 5}

    {HIVE_SPAWN_POINT ("Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 32 30 yes 5}

    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 25 9  yes 6}

    {HIVE_SPAWN_POINT ("Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 27 21 yes 9}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 32 23 yes 6}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 33 23 yes 6}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 28 20 yes 6}

    # Start zone
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 10 4  yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 11 3  yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 14 4  yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 11 7  yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 13 6 yes 5}

    # Just at the start
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone,Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 3  15 yes 6}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone,Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 5  15 yes 7}

    # Watery chamber 1
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 16 8  yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone,Shaxthal Assault Drone") 4 17 9  yes 5}
#ifdef HARD
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 16 8  yes 3}
#endif

    #
    # Tentacles blocking the path to the info glyph
    #
    {HIVE_SPAWN_POINT ("Tentacle of the Deep") 4 47 10 yes 3}
    {HIVE_SPAWN_POINT ("Tentacle of the Deep") 4 41 12 yes 6}
    {HIVE_SPAWN_POINT ("Tentacle of the Deep") 4 39 14 yes 4}
    {HIVE_SPAWN_POINT ("Tentacle of the Deep") 4 40 14 yes 5}
    {HIVE_SPAWN_POINT ("Tentacle of the Deep") 4 37 14 yes 4}
    {HIVE_SPAWN_POINT ("Tentacle of the Deep") 4 37 18 yes 3}
    {HIVE_SPAWN_POINT ("Tentacle of the Deep") 4 39 18 yes 7}

    [event]
        name=start
        [message]
            speaker=Mal Keshar
            message= _ "This place smells of death and decay, but not the kind I enjoy. Something seriously evil goes on in this...warren? Hive? Thing?"
        [/message]

        [message]
            speaker=Galas
            message= _ "Given that those creatures float and have poison in their jaws, I'd call it a hive."
        [/message]

        [message]
            speaker=Lédinor
            message= _ "This place is simply wrong! The air, the walls... Everything is unnatural! It is as if..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "...we are no longer in our own world. Not even Wesmere's underground tunnels can compare to this. There is a dark energy in the air; I would not be surprised if it tried to possess or destroy any of us at any moment."
        [/message]

        [if]
            {VARIABLE_BOOLEAN_EQUALS erathan_alive yes}
            [then]
                [message]
                    speaker=Erathan
                    message= _ "Look out! We have just become prey to a swarm of them!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Lédinor
                    message= _ "Look out! We have just become targets to a swarm of them!"
                [/message]
            [/else]
        [/if]

        [message]
            speaker=Galas
            message= _ "Let's give them a lesson to remember."
        [/message]

        [message]
            speaker=Elynia
            message= _ "A presence... That presence... I felt it when we were escaping from Knalga."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Could it possibly be related to whoever orchestrated that invasion?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Perhaps."
        [/message]

        [message]
            speaker=Galas
            message= _ "If it is, then he will feel my wrath for what he did to Anlindë."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=16-26
            y=12-18
        [/filter]

        [redraw]
        [/redraw]

        [allow_undo]
        [/allow_undo]

        [scroll_to]
            x,y=14,16
        [/scroll_to]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Galas
            message=_"Eh? Are those...pools of lava?"
        [/message]

        [if]
            {VARIABLE_BOOLEAN_EQUALS erathan_alive yes}
            [then]
                [message]
                    speaker=Erathan
                    message= _ "They probably need the warmth to incubate. Like chicken eggs."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Lédinor
                    message= _ "They probably need the warmth to incubate. Like chicken eggs."
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=18,31
                radius=7
            [/filter_location]
        [/filter]

        [store_unit]
            [filter]
                side=2
                [filter_wml]
                    ai_special=guardian
                [/filter_wml]
            [/filter]
            variable=side2_guardians
        [/store_unit]

        {FOREACH side2_guardians k}
            {CLEAR_VARIABLE side2_guardians[$k].ai_special}

            [unstore_unit]
                variable=side2_guardians[$k]
                find_vacant=no
            [/unstore_unit]
        {NEXT k}

        {CLEAR_VARIABLE side2_guardians}

        [remove_shroud]
            side=1
            x,y=18,31
            radius=7
        [/remove_shroud]

        [redraw][/redraw]

        [message]
            speaker=Mal Keshar
            message= _ "Oh, great. A welcoming party, indeed."
        [/message]

        [message]
            type=Chaos Lore
            message= _ "Distract them, we must make some time before the Warlord arrives to finish them off!"
        [/message]

        [message]
            type=Iron Golem
            message= _ "Prepare yourself, intruder!"
        [/message]

        [message]
            speaker=Galas
            message= _ "The Chaos Warlord is coming here? That overlord, Benthos, told us that Anlindë last fought against the Warlord... That fell assassin shall not go unpunished! Brace yourselves!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "I am not sure this is a good idea... I sense a great power heading toward this place. It's coming from beyond those gates!"
        [/message]

        [remove_shroud]
            side=1
            x,y=30,34
            radius=2
        [/remove_shroud]
        [remove_shroud]
            side=1
            x,y=27,33
            radius=2
        [/remove_shroud]
        [redraw][/redraw]
        [scroll_to]
            x,y=29,34
        [/scroll_to]
        [delay]
            time=1500
        [/delay]

        [message]
            speaker=Galas
            message= _ "What else can we do? Run like cowards? Never! We made it this far, there is no turning back."
        [/message]

        [message]
            speaker=Elynia
            message= _ "That's true..."
        [/message]

        [message]
            speaker=Erathan
            message= _ "Get out of our path, churls!"
        [/message]

        [message]
            type=Chaos Lore
            message= _ "You shall not pass!"
        [/message]

        {VARIABLE warlord_approaching yes}

        [event]
            name=new turn
            first_time_only=no
            [if]
                [not]
                    [have_unit]
                        side=2
                    [/have_unit]
                [/not]
                {VARIABLE_BOOLEAN_EQUALS warlord_approaching yes}
                [then]
                    {VARIABLE warlord_approaching no}
                    {PLAY_SOUND dwarf-laugh.wav}
                    # Boss appears
                    # Using a complete MUF locations array to avoid the possibility that the
                    # engine decides to make the fake unit fly over the lava
                    [move_unit_fake]
                        x=37,36,35,34,33,32,31,30,29,28,27,26,25,24,23
                        y=38,37,37,36,36,35,35,34,34,33,33,33,33,32,33
                        type=Fake Chaos Warlord
                        side=3
                    [/move_unit_fake]
                    [unit]
                        side=3
                        type=Chaos Warlord
                        id=Elyssa
                        name= _ "Elyssa"
                        x,y=23,33
                        {IS_BOSS}
                        unrenamable=yes
                        {FACING_REVERSE}
                        female=yes
                        profile="portraits/elyssa.png"
                        variation=unmasked
                    [/unit]
                    [music]
                        name="the_city_falls.ogg"
                        immediate=yes
                    [/music]
                    {BOSS_POPUP}
                    [redraw][/redraw]
                    [scroll_to_unit]
                        id=Elyssa
                    [/scroll_to_unit]
                    [delay]
                        time=1000
                    [/delay]

                    [message]
                        speaker=Mal Keshar
                        message= _ "The warlord is a female!"
                    [/message]

                    [message]
                        speaker=Erathan
                        message= _ "I guess those creatures couldn't tell..."
                    [/message]

                    [message]
                        speaker=Elyssa
                        message= _ "Galas, the elvish leader. You have no idea how long I have been waiting for this moment - to see terror consume your soul as I squash you like an insect. To squash you in the same manner the witch did with me."
                    [/message]

                    [message]
                        speaker=Galas
                        message= _ "So you are the monster that killed Anlindë. You shall pay for that, and I'll make sure that no part of your body remains to resurrect you!"
                    [/message]

                    [message]
                        speaker=Elyssa
                        message= _ "Fool, there is no weapon or magical power left in this world to destroy me permanently. You will only be wasting your last minutes of life!"
                    [/message]

                    [message]
                        speaker=Elynia
                        message= _ "No, we will prevail. You are the one who will waste her last minutes of life."
                    [/message]

                    [message]
                        speaker=Elyssa
                        message= _ "Ah, the formidable Lady of Light... Hm hm hm, you are nothing but a brash, insignificant creature without the help of your beloved. You should be taught not to defy the powers of Uria."
                    [/message]

                    [message]
                        speaker=Mal Keshar
                        message= _ "You'll find nothing but slow learners in that regard..."
                    [/message]

                    [message]
                        speaker=Elyssa
                        message= _ "We have been distracted by more important matters than your pitiful war - you are almost beneath notice. You can try, and keep trying, but the Empire will never fall before you."
                    [/message]

                    [message]
                        speaker=Elyssa
                        message= _ "It was a grave mistake to come here, invading our own fortress. Although my Master had an interest in dealing with you personally, I fear that I cannot allow myself to let your insolence go unpunished. Meet your end, now!"
                    [/message]

                    [objectives]
                        side=1
                        {OBJECTIVE_TO_WIN ( _ "Defeat the Chaos Warlord.")}
                        {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
                        {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
                        {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
                        {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
                        {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
                        {OBJECTIVE_NOTES {ENEMY_RESPAWNING_WARNING} }
                    [/objectives]
                [/then]
            [/if]
        [/event]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x,y=11,3
        [/filter]

        [redraw]
        [/redraw]

        [allow_undo]
        [/allow_undo]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Long live the Machine!"
        [/message]
    [/event]

    [event]
        name=victory
        {GAUNTLET_SAVE_RECALL_METALIST}

        {CLEAR_VARIABLE trance_timeout,warlord_approaching,x_diff,y_diff}
    [/event]

    {ITEM_CRYSTAL_GLYPH_MESSAGE 47 15}
    [event]
        name=moveto
        [filter]
            x,y=47,15
            [not]
                id=Elynia
                [or]
                    id=Mal Keshar
                [/or]
            [/not]
        [/filter]

        [allow_undo][/allow_undo]
        [redraw][/redraw]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "You are not capable of activating this sealed glyph. Perhaps you should send Elynia or Mal Keshar to it instead."
        [/message]
    [/event]
    [event]
        name=moveto
        [filter]
            x,y=47,15
            [and]
                id=Elynia
                [or]
                    id=Mal Keshar
                [/or]
            [/and]
        [/filter]

        [allow_undo][/allow_undo]
        [redraw][/redraw]

        {MSG_GLYPH ( _ "We, the Argazar people, fiddled perilously with the pillars of all lifeforms. And we created unspeakable abominations that we were forced to enhance and mass-produce, as we were losing a war with the planet Rythé.")}
        {MSG_GLYPH ( _ "Those were the Shaxthals. With our great knowledge, we could select the best characteristics of every natural lifeform, add to them great strength and resistance, and then join them together in a single, perfect lifeform. The Biomechanicals, or 'Shaxthals' - which in our ancient tongue meant 'Invincibles'.")}
        {MSG_GLYPH ( _ "However, a cataclysm destroyed all our civilization and creations, except for a few of us who survived long enough to set a secret city underground.")}
        {MSG_GLYPH ( _ "The Rythenians thought we were gone.")}
        {MSG_GLYPH ( _ "But the Shaxthals had their own survival system.")}
        {MSG_GLYPH ( _ "Most of the biomechanicals that were on the planet's surface during the cataclysm were probably destroyed, but a small number of them survived with us underground. However, we forgot an important detail: their instincts.")}
        {MSG_GLYPH ( _ "Their instincts prevailed, and drove them to begin consuming our civilization - taking our bodies and integrating them into their own image. They possessed an advanced assimilation system which allowed them to merge into new environments, or alter them to suit their needs.")}
        {MSG_GLYPH ( _ "Not just environments, but their organisms as well. The Shaxthals had the same knowledge of technology we had, but not the knowledge of genetics or magic. Yet, that was more than enough to convert our comrades into mindless servants of their 'system'.")}
        {MSG_GLYPH ( _ "Although we tried to make sure their hive could not grow bigger, we noticed that they had developed their own means of reproduction. Their numbers were increasing quickly.")}
        {MSG_GLYPH ( _ "With barely a few dozen of us left, we figured out a way to destroy the Shaxthals. The strongest ones, few as they were, survived. Our elders decided to keep them in cryogenic pods instead of destroying them forever, as they believed they could still be our last hope of survival.")}
        {MSG_GLYPH ( _ "But we eventually disappeared. We, as animals, finally arrived at a dead end, with no means of reproduction. Our attempts to reproduce our species in a way similar to that of the Shaxthals were futile.")}
        {MSG_GLYPH ( _ "Only our knowledge survived, in the form of these glyphs. And in the form of the pods that contained the remaining Shaxthals.")}
        {MSG_GLYPH ( _ "It is our final hope that all this accumulated knowledge, technology, and history are not used for malign purposes.")}

        [message]
            speaker=Mal Keshar
            message= _ "That's one heck of a history - it will take some time to digest."
        [/message]
        [message]
            speaker=Erathan
            message= _ "Really? Do you have a stomach in there?"
        [/message]
        [message]
            speaker=Igor
            message= _ "Eeeeew."
        [/message]
        [message]
            speaker=Elynia
            message= _ "I guess this explains the strange lifeforms we have found in here. So someone must have unleashed them from their container pods."
        [/message]
        [message]
            speaker=Galas
            message= _ "One would think that whoever did should have been smart enough to find this history first, right? That means he or she did it on purpose. Perhaps it would have been better if that person had been assimilated by these creatures too."
        [/message]
        [message]
            speaker=Mal Keshar
            message= _ "Perhaps they already have."
        [/message]
    [/event]

    [event]
        name=union trance effect
        first_time_only=no
        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            variable=trance_elynia_store
        [/store_unit]
        [store_unit]
            [filter]
                id=Mal Keshar
            [/filter]
            variable=trance_malin_store
        [/store_unit]

        {VARIABLE trance_elynia_store.attacks_left 0}
        {VARIABLE trance_malin_store.attacks_left  0}
        {VARIABLE trance_elynia_store.moves        0}
        {VARIABLE trance_malin_store.moves         0}

        [unstore_unit]
            variable=trance_malin_store
            find_vacant=no
        [/unstore_unit]
        [unstore_unit]
            variable=trance_elynia_store
            find_vacant=no
        [/unstore_unit]

        {CLEAR_VARIABLE trance_malin_store,trance_elynia_store}
    [/event]

    [event]
        name=union trance end
        first_time_only=yes

        {THUNDER ({QUAKE (rumble.ogg)})}
        {THUNDER ()}
        {THUNDER ()}
        {THUNDER ({QUAKE (cave-in.ogg)})}
        {THUNDER ()}

        [object]
            id=union_elynia
            duration=forever
            silent=yes
            [filter]
                id=Elynia
            [/filter]
            [effect]
                apply_to=new_ability
                [abilities]
                    {ABILITY_UNION}
                [/abilities]
            [/effect]
            {UNION_HP}
            {UNION_ATTACK}
        [/object]
        [object]
            id=union_malin
            duration=forever
            silent=yes
            [filter]
                id=Mal Keshar
            [/filter]
            [effect]
                apply_to=type
                name=Ancient Lich with Union
            [/effect]
        [/object]

        [redraw][/redraw]

        [message]
            speaker=Elyssa
            message= _ "What? No! It is... It is impossible! You have summoned the power of the Union!!"
        [/message]

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Use the 'Union' with Elynia or Mal Keshar to vanquish the Warlord.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
        [/objectives]
    [/event]

    [event]
        name=union trance begin
        [message]
            speaker=Galas
            message= _ "Protect them!"
        [/message]
        {VARIABLE trance_timeout 2}
        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Distract the Warlord for two turns, during which Elynia and Mal Keshar will not be able to move or attack.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES {ENEMY_RESPAWNING_WARNING} }
        [/objectives]
        [fire_event]
            name=union trance effect
        [/fire_event]
        [event]
            name=new turn
            first_time_only=no
            [if]
                {VARIABLE_NUMERICAL_GREATER_OR_EQUAL_THAN trance_timeout 0}
                [then]
                    {VARIABLE_DEC trance_timeout}
                [/then]
            [/if]
        [/event]
        [event]
            name=turn refresh
            first_time_only=no
            [if]
                {VARIABLE_NUMERICAL_GREATER_OR_EQUAL_THAN trance_timeout 0}
                [then]
                    [fire_event]
                        name=union trance effect
                    [/fire_event]
                [/then]
                [else]
                    [fire_event]
                        name=union trance end
                    [/fire_event]
                [/else]
            [/if]
        [/event]
    [/event]

    [event]
        name=die
        first_time_only="yes"
        [filter]
            id=Elyssa
        [/filter]
        [filter_second_attack]
            name=union
        [/filter_second_attack]

        [message]
            speaker=unit
            message= _ "I'll be back!"
        [/message]

        {VARIABLE t_x1 $x1}
        {VARIABLE t_y1 $y1}

        [kill]
            x=$t_x1
            y=$t_y1
            animate=no
            fire_event=no
        [/kill]

        [move_unit_fake]
            x=$t_x1,27,30,37
            y=$t_y1,33,34,38
            type=Fake Chaos Warlord
            side=3
        [/move_unit_fake]

        [redraw][/redraw]

        [message]
            speaker=Mal Keshar
            message= _ "She is fleeing to the deeper passages! We can't let her escape!"
        [/message]

        [message]
            speaker=Galas
            message= _ "Onwards then! She must pay for her evil deeds."
        [/message]

        {ENDLEVEL_CONTINUE}
    [/event]

    [event]
        name=die
        first_time_only="no"
        [filter]
            id=Elyssa
        [/filter]
        [filter_second_attack]
            [not]
                name=union
            [/not]
        [/filter_second_attack]
        [unit]
            side=3
            attacks_left,moves=0,0 # in case she's respawned during her own turn
            type=Chaos Warlord
            id=Elyssa
            name= _ "Elyssa"
            x,y=23,33
            {IS_BOSS}
            unrenamable=yes
            facing=$unit.facing
            female=yes
            profile="portraits/elyssa.png"
            variation=unmasked
        [/unit]
    [/event]

    [event]
        name=die
        first_time_only="yes"
        [filter]
            id=Elyssa
        [/filter]
        [filter_second_attack]
            [not]
                name=union
            [/not]
        [/filter_second_attack]

        [message]
            speaker=Elyssa
            message= _ "I told you so, fools. I am immortal!"
        [/message]

        [message]
            speaker=Galas
            message= _ "If none of you can think of a good idea, this is surely our end! Our backs are surrounded by lava, and it seems that no matter what we try, we can't defeat her!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "I... There is nothing that we can do against this unnatural power. If only Argan were still with us... Unless... I... I have an idea..."
        [/message]

        [message]
            speaker=Lédinor
            message= _ "Let's hear it, then."
        [/message]

        [message]
            speaker=Igor
            message= _ "Anything is better than nothing now!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "It is highly risky...and I'll need Malin's help. Malin, can I trust you and place our lives in your hands?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Eh... your lives? What do you have in mind?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "We need to put our hands together and concentrate."
        [/message]

        [message]
            speaker=Elynia
            message= _ "When you chose this unlife for yourself, you bound yourself to the ways of Darkness for the rest of eternity. There is nothing that can be done to remedy that now. However, the powers of Darkness are not necessarily evil by themselves; they *can* be put to good use. If we work together, I am sure we can call upon the ultimate balance of Light and Darkness, and use it to turn this fight to our advantage."
        [/message]

        [message]
            speaker=Elynia
            message= _ "We will try to call upon the power of the Union using your mastery of Darkness to replace Argan's."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "We will WHAT?! No, no, wait! I am no hero! I...am not supposed to do this... I am supposed to kill you, and be on my merry way to eternal damnation..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Malin, you did many things in the past, many wrong things. But you also did us a great good - you guided Galas and his loyal followers to the deepest parts of Irdya, awoke me from my long slumber, and opened my blind eyes to the new order. You cannot say you are not suited for this task anymore. It is your fate, after all. Would you prefer to remain hidden underground like a rat, or would you rather fight for a just cause a final time?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Pah, alright. As you wish, Elynia..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "We must not be interrupted! You'll have to find a way to distract the Warlord for now, Galas."
        [/message]

        [message]
            speaker=Galas
            message= _ "So we shall."
        [/message]

        [message]
            speaker=Erathan
            message= _ "Aye."
        [/message]

        [message]
            speaker=Lédinor
            message= _ "Aye!"
        [/message]

        [message]
            speaker=Igor
            message= _ "Yeah!"
        [/message]

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Move Elynia and Mal Keshar so that they are on adjacent hexes.")}
            {OBJECTIVE_TO_WIN ( _ "Distract the Warlord.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES {ENEMY_RESPAWNING_WARNING} }
        [/objectives]

        [store_locations]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_loc
        [/store_locations]
        [store_locations]
            [filter]
                id=Mal Keshar
            [/filter]
            kill=no
            variable=malin_loc
        [/store_locations]

        {VARIABLE loc_diff "$(max(abs($elynia_loc.x-$malin_loc.x), abs($elynia_loc.y-$malin_loc.y)))"}

        [if]
            {VARIABLE_NUMERICAL_EQUALS loc_diff 1}
            [then]
                [fire_event]
                    name=union trance begin
                [/fire_event]
            [/then]
            [else]
                [event]
                    name=moveto
                    first_time_only=no
                    [filter]
                        id=Elynia
                        [filter_adjacent]
                            id=Mal Keshar
                        [/filter_adjacent]
                        [or]
                            id=Mal Keshar
                            [filter_adjacent]
                                id=Elynia
                            [/filter_adjacent]
                        [/or]
                    [/filter]
                    [fire_event]
                        name=union trance begin
                    [/fire_event]
                [/event]
            [/else]
        [/if]

        {CLEAR_VARIABLE loc_diff,malin_loc,elynia_loc}
    [/event]
[/scenario]
